Version =19
VersionRequired =19
Checksum =-1535401661
Begin Form
    RecordSelectors = NotDefault
    NavigationButtons = NotDefault
    DividingLines = NotDefault
    AllowDesignChanges = NotDefault
    DefaultView =0
    TabularCharSet =128
    TabularFamily =50
    PictureAlignment =2
    DatasheetGridlinesBehavior =3
    GridY =10
    Width =8850
    DatasheetFontHeight =11
    ItemSuffix =29
    Left =1890
    Top =345
    Right =10740
    Bottom =4920
    RecSrcDt = Begin
        0xd71f4e85af6ee340
    End
    DatasheetFontName ="ＭＳ Ｐゴシック"
    PrtMip = Begin
        0x6801000068010000680100006801000000000000201c0000e010000001000000 ,
        0x010000006801000000000000a10700000100000001000000
    End
    PrtDevMode = Begin
        0x4550534f4e20504d2d3934304300000000000000000000000000000000000000 ,
        0x010470049c0076010f9b8007010009009a0b3408640001000700680102000100 ,
        0x6801000000000000000000000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000000000000000000000001000000 ,
        0x0000000001000000050000000000000000000000000000000000000000000000 ,
        0x01000000340800009a0b00000000020000000100010000000100030000000500 ,
        0x0200b40001000000000000000200000000000000000001000000000000000000 ,
        0x0000000000000000000000000500000001000000000000000000000000000000 ,
        0x0000000000000000000000000000000000000100000000000000000000000000 ,
        0x000001000000010000002a0000002a0000002a000000c6000000a00b00007110 ,
        0x0000680100006801000000000000444c4c4e616d6533323d455f445531374d4a ,
        0x2e444c4c000000000000000000000000000009004c0b0000810f000064004c0b ,
        0x0000810f00000000000014000000000000000000000000000000000032000000 ,
        0xff00000001000000000000000000000000004500500053004f004e0020005000 ,
        0x4d002d0039003400300043000000000000000000000000000000000000000000 ,
        0x0000000000000000000000000000000000001104000000010800000000001e00 ,
        0x01002a0000002a0000002a000000c6000000
    End
    PrtDevNames = Begin
        0x08001600240001004550534f4e20504d2d39343043004550534f4e20504d2d39 ,
        0x3430430055534230303100
    End
    OnLoad ="[Event Procedure]"
    Begin
        Begin Label
            BackStyle =0
            TextFontCharSet =128
            FontSize =11
            FontName ="ＭＳ Ｐゴシック"
        End
        Begin CommandButton
            TextFontCharSet =128
            Width =1701
            Height =435
            FontSize =11
            FontWeight =400
            ForeColor =-2147483630
            FontName ="ＭＳ Ｐゴシック"
        End
        Begin CheckBox
            SpecialEffect =2
            LabelX =230
            LabelY =-30
        End
        Begin TextBox
            FELineBreak = NotDefault
            TextFontCharSet =128
            Width =1701
            Height =270
            LabelX =-1701
            FontSize =11
            BorderColor =12632256
            FontName ="ＭＳ Ｐゴシック"
        End
        Begin Section
            Height =4592
            Name ="詳細"
            GUID = Begin
                0x1b40d62d4351d942921628f79cf6d048
            End
            Begin
                Begin Label
                    OverlapFlags =85
                    TextFontFamily =50
                    Left =283
                    Width =2940
                    Height =285
                    FontSize =13
                    FontWeight =700
                    ForeColor =16711680
                    Name ="ラベル0"
                    Caption ="最新 郵便番号辞書作成"
                    GUID = Begin
                        0x20739875478f034da73ab10d9cd69931
                    End
                End
                Begin TextBox
                    OverlapFlags =85
                    Left =1980
                    Top =1191
                    Width =5901
                    Name ="テキスト10"
                    GUID = Begin
                        0xdec21d78069fcf44815154b038c2226f
                    End
                End
                Begin Label
                    OverlapFlags =85
                    Left =510
                    Top =793
                    Width =7725
                    Height =240
                    Name ="ラベル12"
                    Caption ="展開した ken_all.csv jigyosyo.csv の入っているディレクトリを指定してください。"
                    GUID = Begin
                        0xa184974e02da204598641f1d17e56c5e
                    End
                End
                Begin Label
                    OverlapFlags =85
                    Left =840
                    Top =1187
                    Width =1080
                    Height =240
                    Name ="ラベル13"
                    Caption ="フォルダ名"
                    GUID = Begin
                        0xed6355751f229e4ea6f162e379b1fee6
                    End
                End
                Begin CheckBox
                    OverlapFlags =85
                    Left =1243
                    Top =1645
                    TabIndex =1
                    Name ="チェック14"
                    GUID = Begin
                        0xc0d7b145e38c484c9ff3893203e99e01
                    End
                    Begin
                        Begin Label
                            OverlapFlags =247
                            Left =1470
                            Top =1622
                            Width =3330
                            Height =270
                            Name ="ラベル15"
                            Caption ="住所の読みがなを全角に変換する"
                            GUID = Begin
                                0xf61d63af495db44bab04e8f572754774
                            End
                        End
                    End
                End
                Begin CommandButton
                    OverlapFlags =85
                    Left =7937
                    Top =1145
                    Width =385
                    Height =344
                    TabIndex =2
                    Name ="コマンド16"
                    Caption ="..."
                    OnClick ="[Event Procedure]"
                    GUID = Begin
                        0xd80a2a5d3a79d146bce1868543288551
                    End
                End
                Begin CommandButton
                    OverlapFlags =85
                    Left =2777
                    Top =2154
                    TabIndex =3
                    Name ="コマンド17"
                    Caption ="取り込み"
                    OnClick ="[Event Procedure]"
                    GUID = Begin
                        0x2b6edb5ce311e142995c68769ce1b2f9
                    End
                End
                Begin Label
                    OverlapFlags =85
                    Left =630
                    Top =2265
                    Width =2100
                    Height =240
                    Name ="ラベル18"
                    Caption ="準備ができたら、この"
                    GUID = Begin
                        0x9a76fe7709c72744a4033560ad71a0cc
                    End
                End
                Begin Label
                    OverlapFlags =85
                    Left =4710
                    Top =2205
                    Width =4140
                    Height =240
                    Name ="ラベル22"
                    Caption ="ボタンをクリックして 完了メッセージが"
                    GUID = Begin
                        0x8ddd3f79c92c8b43a1b8e3c1d378a05d
                    End
                End
                Begin Label
                    OverlapFlags =85
                    Left =510
                    Top =453
                    Width =7725
                    Height =240
                    Name ="ラベル23"
                    Caption ="日本郵便から 郵便番号データ (lzh形式) を ダウンロードして 展開してください。"
                    GUID = Begin
                        0x474ffaf6d86f2541bff106e43aa4b870
                    End
                End
                Begin Label
                    OverlapFlags =85
                    TextFontFamily =50
                    Left =510
                    Top =3750
                    Width =7725
                    Height =690
                    FontWeight =700
                    ForeColor =32768
                    Name ="ラベル24"
                    Caption ="この「郵便番号辞書作成」 は シェアウェアです。\015\012業務目的で継続してご利用になる場合、送金をお願いします。\015\012 （送金後はこのコメント"
                        "を削除していただいて結構です。)"
                    GUID = Begin
                        0x745e64de3f078648a8e1573d5dd5863a
                    End
                End
                Begin Label
                    OverlapFlags =85
                    Left =4695
                    Top =2550
                    Width =4125
                    Height =465
                    Name ="ラベル25"
                    Caption ="出るまで、しばらく待ちます。"
                    GUID = Begin
                        0xcfaad84727757749ad4c7d5480e40835
                    End
                End
                Begin Label
                    Visible = NotDefault
                    OverlapFlags =85
                    TextFontFamily =50
                    Left =623
                    Top =3174
                    Width =7755
                    Height =390
                    FontWeight =700
                    ForeColor =16711680
                    Name ="ラベルメッセージ"
                    Caption ="メッセージ"
                    GUID = Begin
                        0xf97630f5b5578d40b7a799af9d6240d5
                    End
                End
            End
        End
    End
End
CodeBehindForm
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = True
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
'2009.05.11 ２００９年４月の日本郵便のデータは 企業郵便番号に 地域の郵便番号と一緒の番号があるので対処
'

Option Compare Database

Private Sub Form_Load()
    Me.チェック14.Value = True
End Sub

Private Sub コマンド16_Click()

    ' Microsoft Office 11.0 Object Library への参照設定が必要です。
    Dim foldername As String
   
    Dim fDialog As Office.FileDialog
    
    ' ファイル ダイアログ ボックスを設定します。
    Set fDialog = Application.FileDialog(msoFileDialogFolderPicker)

    With fDialog
        'ダイアログのタイトルを設定
        .Title = "ken_all.csv や jigyosyo.csv ファイルのあるフォルダを指定してください。"
        'ダイアログを表示
      
        .Filters.Clear
        '.Filters.Add "CSV ファイル", "*.CSV"

        If .Show = True Then
            foldername = Trim(.SelectedItems.Item(1))
        Else
            foldername = ""
        End If
    End With
    
    Me.テキスト10.Value = foldername
    
End Sub

Private Sub ClearMessage()
    Me.ラベルメッセージ.Caption = ""
    Me.ラベルメッセージ.Visible = True
    Me.Repaint
End Sub

Private Sub AddMessage(msg As String)
    Me.ラベルメッセージ.Caption = msg
    Me.Repaint
End Sub


Private Sub AddStatusChar(c As String)
    Me.ラベルメッセージ.Caption = Me.ラベルメッセージ.Caption & c
    Me.Repaint
End Sub


Private Sub コマンド17_Click()
    On Error GoTo error_exec
   
    Me.テキスト10.SetFocus
    Me.コマンド17.Enabled = False
    
    ClearMessage
    
    'CSVファイルの確認
    Dim ken_all_csv As String
    Dim jigyosyo_csv As String
    Dim sql As String
    Dim input_file As String
    
    
    ken_all_csv = Me.テキスト10.Value & "\ken_all.csv"
    jigyosyo_csv = Me.テキスト10.Value & "\jigyosyo.csv"
    
    If (Not FileExists(ken_all_csv)) And (Not FileExists(jigyosyo_csv)) Then
        MsgBox "郵便番号データ (csv ファイル) がありません。"
        Exit Sub
    End If
    
    DoCmd.SetWarnings False
    
    AddMessage "取り込みを開始します。終了までしばらくお待ちください...。"
    
    If FileExists(ken_all_csv) Then
        AddMessage "住所の郵便番号(ken_all.csv) 取り込み開始"
        
        DoCmd.RunSQL "DELETE * FROM U_番号"
        DoCmd.TransferText acImportDelim, "ken_all定義", "U_番号", ken_all_csv, False

        AddMessage "U_SUBテーブル作成中"
        DoCmd.RunSQL "delete * from U_Sub"
       
        sql = "INSERT INTO U_Sub ( 地域, KenR, ShiR, 県, 市 )" & _
                " SELECT U_番号.地域, U_番号.KenR, U_番号.ShiR, U_番号.県, U_番号.市" & _
                " FROM U_番号 " & _
                " GROUP BY U_番号.地域, U_番号.KenR, U_番号.ShiR, U_番号.県, U_番号.市;"
        DoCmd.RunSQL sql
    
        '半角を全角に変換する。
        If Me.チェック14.Value = True Then
            AddMessage "半角ｶﾀｶﾅを全角ひらがなに変換中（住所データ）"
            data_han_to_zen_U_SUB
            data_han_to_zen_U_番号
        End If
        
        input_file = "住所郵便番号"
        
    End If
    
    If FileExists(jigyosyo_csv) Then
        AddMessage "企業の郵便番号(jigyosyo.csv) 取り込み開始"
        
        DoCmd.RunSQL "DELETE * FROM U_企業"
        DoCmd.TransferText acImportDelim, "jigyosyo定義", "U_企業", jigyosyo_csv, False

        '半角を全角に変換する。
        If Me.チェック14.Value = True Then
            data_han_to_zen_U_企業
        End If
    
        input_file = input_file & " 企業の郵便番号"
    End If

    AddMessage "U7_県対応表 テーブル作成中"
    data_add_U7_県対応表
        
    AddMessage "郵便番号データの取り込みが完了しました。"
    
    MsgBox input_file & "の取り込みが完了しました。"
        
exit_sub:
    DoCmd.SetWarnings True
    Me.コマンド17.Enabled = True
    
    Exit Sub
    
error_exec:
    MsgBox "取り込み処理中にエラーが発生しました。：" & Err.Description
    Resume exit_sub
    
End Sub


Private Sub data_add_U7_県対応表()

    DoCmd.RunSQL "DELETE * FROM U7_県対応表"

    '-- 考え方 U7 １つにつき１つだけ「県」と「地域」を抽出する。
    Dim rs As New ADODB.Recordset
    Dim sql As String
    sql = "select U7,県,地域 from U_番号 " & _
        " union select U7,県,地域 from U_企業 order by U7,地域"
    
    rs.Open sql, CurrentProject.Connection, adOpenForwardOnly
    
    Dim wrs As Recordset
    Set wrs = CurrentDb.OpenRecordset("U7_県対応表")
    Dim u7 As String
    
    u7 = ""
    Dim n As Integer
    n = 0
    
    While Not rs.EOF
        If rs!u7 <> u7 Then
            wrs.AddNew
            wrs!u7 = rs!u7
            wrs!県 = rs!県
            wrs!地域 = rs!地域
            wrs.Update
            u7 = rs!u7
        Else
            '同じ７桁郵便番号の場合はスキップする。
        End If
        
        rs.MoveNext
    Wend

    rs.Close
End Sub

Private Sub data_han_to_zen_U_SUB()
    Dim rs As Recordset
    Dim ken_r As String
    Dim ken_h As String
    Dim s As String
    Dim n As Integer
    
    Set rs = CurrentDb.OpenRecordset("U_SUB")
    
    n = 0
    While Not rs.EOF

        rs.Edit
        'KEN_R は同じ文字がくる可能性が高いので ken_h を再利用する。
        s = rs!KenR
        If s = ken_r Then
            rs!KenR = ken_h
        Else
            ken_r = rs!KenR
            ken_h = StrConv(ken_r, vbWide + vbHiragana)
            rs!KenR = ken_h
        End If
        
        rs!ShiR = StrConv(rs!ShiR, vbWide + vbHiragana)
        rs.Update
        rs.MoveNext
        
        n = n + 1
        If n > 5000 Then
            n = 0
            AddStatusChar "+"
        End If

    Wend
    
End Sub

Private Sub data_han_to_zen_U_企業()
'テーブルに取り込まれた半角を全角に変換する。
    Set rs = CurrentDb.OpenRecordset("U_企業")
    Dim n As Integer
    
    While Not rs.EOF
        rs.Edit
        rs!事業所名かな = StrConv(rs!事業所名かな, vbWide + vbHiragana)
        rs.Update
        rs.MoveNext
        
        n = n + 1
        If n > 5000 Then
            n = 0
            AddStatusChar "+"
        End If

    Wend
    
End Sub


Private Sub data_han_to_zen_U_番号()
    'U_SUB が正しく半角から全角に変換されているのが前提
    
    Dim sub_rs As New ADODB.Recordset
    Dim sub_num As String
    Dim rs As Recordset
    Dim s As String
    Dim total_n As Long
    Dim now_n As Integer
    Dim n As Integer
    
    Set rs = CurrentDb.OpenRecordset("U_番号")
    sub_rs.Open "select * from U_SUB where 0 = 1", CurrentProject.Connection
    
    n = 0
    While Not rs.EOF
        rs.Edit
        If (sub_num <> rs!地域) Then
            sub_num = rs!地域
            sub_rs.Close
            'Set sub_rs = CurrentDb.OpenRecordset("select * from U_SUB where 地域 = '" & sub_num & "'", dbOpenSnapshort)
            sub_rs.Open "select * from U_SUB where 地域 = '" & sub_num & "'", CurrentProject.Connection
        End If
        rs!KenR = sub_rs!KenR
        rs!ShiR = sub_rs!ShiR
        rs!町R = StrConv(rs!町R, vbWide + vbHiragana)
        rs.Update
        rs.MoveNext
        
        n = n + 1
        If n > 5000 Then
            n = 0
            AddStatusChar "+"
        End If

    Wend

End Sub

Public Function FileExists(path As String)
    Dim fso As New FileSystemObject
    
    If fso.FileExists(path) Then
        FileExists = True
    Else
        FileExists = False
    End If
    
End Function